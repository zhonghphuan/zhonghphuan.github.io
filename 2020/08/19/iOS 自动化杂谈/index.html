<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"8.0.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="前言：可持续集成自动化的话题已经老生常谈了。目前市面上比较流行的自动化流程工具——Fastlane，Fastlane是用Ruby语言编写的一套自动化工具集和框架，Fastlane的工具集基本上涵盖了打包，签名，测试，部署，发布，库管理等等用起来比较方便，配合Jenkins可持续化集成，基本可以满足大部分的流程自动化。">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS 自动化杂谈">
<meta property="og:url" content="http://yoursite.com/2020/08/19/iOS%20%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9D%82%E8%B0%88/index.html">
<meta property="og:site_name" content="钟环">
<meta property="og:description" content="前言：可持续集成自动化的话题已经老生常谈了。目前市面上比较流行的自动化流程工具——Fastlane，Fastlane是用Ruby语言编写的一套自动化工具集和框架，Fastlane的工具集基本上涵盖了打包，签名，测试，部署，发布，库管理等等用起来比较方便，配合Jenkins可持续化集成，基本可以满足大部分的流程自动化。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/images/iOS-%E8%87%AA%E5%8A%A8%E5%8C%96-%E6%89%93%E5%8C%85/%E8%87%AA%E5%8A%A8%E5%8C%961.jpg">
<meta property="og:image" content="http://yoursite.com/images/iOS-%E8%87%AA%E5%8A%A8%E5%8C%96-%E6%89%93%E5%8C%85/WX20200820-163454@2x.png">
<meta property="og:image" content="http://yoursite.com/images/iOS-%E8%87%AA%E5%8A%A8%E5%8C%96-%E6%89%93%E5%8C%85/image2020-4-9_17-4-42.png">
<meta property="og:image" content="http://yoursite.com/images/iOS-自动化-打包/WX20200820-170210@2x.png">
<meta property="og:image" content="http://yoursite.com/images/iOS-%E8%87%AA%E5%8A%A8%E5%8C%96-%E6%89%93%E5%8C%85/WX20200820-181953@2x.png">
<meta property="og:image" content="http://yoursite.com/images/iOS-%E8%87%AA%E5%8A%A8%E5%8C%96-%E6%89%93%E5%8C%85/WX20200820-183925@2x.png">
<meta property="og:image" content="http://yoursite.com/images/iOS-%E8%87%AA%E5%8A%A8%E5%8C%96-%E6%89%93%E5%8C%85/WX20200821-111336@2x.png">
<meta property="article:published_time" content="2020-08-18T23:47:42.000Z">
<meta property="article:modified_time" content="2020-08-22T03:31:39.000Z">
<meta property="article:author" content="钟环">
<meta property="article:tag" content="自动化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/images/iOS-%E8%87%AA%E5%8A%A8%E5%8C%96-%E6%89%93%E5%8C%85/%E8%87%AA%E5%8A%A8%E5%8C%961.jpg">


<link rel="canonical" href="http://yoursite.com/2020/08/19/iOS%20%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9D%82%E8%B0%88/">


<script data-pjax class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>iOS 自动化杂谈 | 钟环</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="钟环" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">钟环</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%80-%E6%89%93%E5%8C%85"><span class="nav-number">1.</span> <span class="nav-text">一. 打包</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BA%8C-testflight-%E8%87%AA%E5%8A%A8%E5%8C%96%E5%85%AC%E6%B5%8B"><span class="nav-number">2.</span> <span class="nav-text">二. testflight 自动化公测</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%89-%E6%80%BB%E7%BB%93"><span class="nav-number">3.</span> <span class="nav-text">三. 总结</span></a></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="钟环"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">钟环</p>
  <div class="site-description" itemprop="description">个人博客,主要涉及移动端、前后端知识共享、前沿技术共同学习等方面</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/zhonghphuan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhonghphuan" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhonghphuan@hotmail.com" title="E-Mail → mailto:zhonghphuan@hotmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </section>
        <div class="back-to-top animated">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/19/iOS%20%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9D%82%E8%B0%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="钟环">
      <meta itemprop="description" content="个人博客,主要涉及移动端、前后端知识共享、前沿技术共同学习等方面">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="钟环">
    </span>

    
    
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          iOS 自动化杂谈
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-08-19 07:47:42" itemprop="dateCreated datePublished" datetime="2020-08-19T07:47:42+08:00">2020-08-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-08-22 11:31:39" itemprop="dateModified" datetime="2020-08-22T11:31:39+08:00">2020-08-22</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%87%AA%E5%8A%A8%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">自动化</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>26k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>23 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <blockquote>
<p>前言：可持续集成自动化的话题已经老生常谈了。目前市面上比较流行的自动化流程工具——Fastlane，Fastlane是用Ruby语言编写的一套自动化工具集和框架，Fastlane的工具集基本上涵盖了打包，签名，测试，部署，发布，库管理等等用起来比较方便，配合Jenkins可持续化集成，基本可以满足大部分的流程自动化。</p>
</blockquote>
<p><img src="/images/iOS-%E8%87%AA%E5%8A%A8%E5%8C%96-%E6%89%93%E5%8C%85/%E8%87%AA%E5%8A%A8%E5%8C%961.jpg"></p>
<a id="more"></a>
<h5 id="一-打包"><a href="#一-打包" class="headerlink" title="一. 打包"></a>一. 打包</h5><blockquote>
<p>实现打包有很多种，例如xcodebuild，但已经有好用的工具集为何不用呢？<br>跟着打包的流程写脚本，例如我想打包，得提供给别人选择哪个分支，采用什么类型，及时通知等</p>
</blockquote>
<p><img src="/images/iOS-%E8%87%AA%E5%8A%A8%E5%8C%96-%E6%89%93%E5%8C%85/WX20200820-163454@2x.png"></p>
<ul>
<li>Jenkins上装了Git parameter plug-In 0.9.12版本的插件进行分支选择</li>
<li>想暴露什么参数在Jenkins上自定义</li>
<li>利用fastlane gym </li>
<li>上传蒲公英</li>
<li>由于之前蒲公英挂过一次，不能完全依赖第三方分发平台，自己再自建一个OTA服务器来内测分发</li>
<li>自定义内测的二维码采用python myqr生成</li>
<li>消息通知：我司采用企业微信，那就搞个机器人webhook一下，当然也可以脚本发个邮件</li>
<li>符号表选择是否上传</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">desc <span class="string">&quot;ad_Hoc 版本&quot;</span></span><br><span class="line">  lane <span class="symbol">:beta</span> <span class="keyword">do</span>  <span class="params">|options|</span></span><br><span class="line">    <span class="comment"># 新建build号</span></span><br><span class="line">    new_build = options[<span class="symbol">:new_build</span>]</span><br><span class="line">    time = Time.new.strftime(<span class="string">&quot;%Y-%m-%d-%H:%M:%S&quot;</span>)</span><br><span class="line">    increment_build_number(</span><br><span class="line">      <span class="symbol">build_number:</span> new_build,</span><br><span class="line">      <span class="symbol">xcodeproj:</span> <span class="string">&quot;xxxxx.xcodeproj&quot;</span></span><br><span class="line">    )</span><br><span class="line">    sh(<span class="string">&quot;pod repo update&quot;</span>)</span><br><span class="line">    <span class="comment"># 拉取代码</span></span><br><span class="line">    cocoapods</span><br><span class="line">    <span class="comment"># 获取版本号</span></span><br><span class="line">    version = get_version_number(</span><br><span class="line">      <span class="symbol">xcodeproj:</span> <span class="string">&quot;xxxxx.xcodeproj&quot;</span>,</span><br><span class="line">      <span class="symbol">target:</span> <span class="string">&quot;xxxxx&quot;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 打包环境</span></span><br><span class="line">    configuration = (options[<span class="symbol">:configuration</span>] ? options[<span class="symbol">:configuration</span>] : <span class="string">&quot;Release&quot;</span>)</span><br><span class="line">    ipaName=<span class="string">&quot;xxxxx&quot;</span></span><br><span class="line">    ipaPath=configuration + <span class="string">&quot;/&quot;</span> + version + <span class="string">&quot;.&quot;</span> + new_build + <span class="string">&quot;/&quot;</span></span><br><span class="line">    <span class="comment"># 导出ipa包地址</span></span><br><span class="line">    output_directory = <span class="string">&quot;/Users/admin/WebSites/app/ipa/&quot;</span> + ipaPath</span><br><span class="line">    <span class="comment">#manifest.plilst需要的参数</span></span><br><span class="line">    ipaUrl=<span class="string">&#x27;https://10.104.33.114/app/ipa/&#x27;</span> + ipaPath + ipaName + <span class="string">&#x27;.ipa&#x27;</span></span><br><span class="line">    plistPath = <span class="string">&#x27;https://10.104.33.114/app/ipa/&#x27;</span> + ipaPath + <span class="string">&#x27;manifest.plist&#x27;</span></span><br><span class="line">    pngName = version + <span class="string">&quot;.&quot;</span> + new_build + <span class="string">&#x27;.png&#x27;</span></span><br><span class="line">    disImg =<span class="string">&#x27;https://10.104.33.114/app/icon/&#x27;</span> + pngName</span><br><span class="line">    gym(</span><br><span class="line">      <span class="symbol">scheme:</span> <span class="string">&quot;xxxxx&quot;</span>,</span><br><span class="line">      <span class="symbol">workspace:</span> <span class="string">&quot;xxxxx.xcworkspace&quot;</span>,</span><br><span class="line">      <span class="symbol">export_method:</span><span class="string">&quot;ad-hoc&quot;</span>,</span><br><span class="line">      <span class="symbol">output_directory:</span> output_directory,<span class="comment">#文件路径</span></span><br><span class="line">      <span class="symbol">clean:</span> <span class="literal">true</span>,</span><br><span class="line">      <span class="symbol">configuration:</span> configuration,</span><br><span class="line">      <span class="symbol">export_options:</span>&#123;</span><br><span class="line">         <span class="symbol">manifest:</span> &#123;</span><br><span class="line">             <span class="symbol">appURL:</span> ipaUrl,</span><br><span class="line">             <span class="symbol">displayImageURL:</span> disImg,</span><br><span class="line">             <span class="symbol">fullSizeImageURL:</span> disImg</span><br><span class="line">             &#125;,</span><br><span class="line">         &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 参数传给内测分发网页</span></span><br><span class="line">    size =<span class="string">`echo $(wc -c &lt; <span class="subst">#&#123;output_directory&#125;</span><span class="subst">#&#123;ipaName&#125;</span>.ipa)`</span></span><br><span class="line">    desc = URI::encode(options[<span class="symbol">:desc</span>])</span><br><span class="line">    appBuildURL = <span class="string">&quot;http://10.104.33.114/app/index.html?&quot;</span> + <span class="string">&quot;version=&quot;</span> + version + <span class="string">&quot;&amp;&quot;</span> + <span class="string">&quot;build=&quot;</span> + new_build + <span class="string">&quot;&amp;&quot;</span> + <span class="string">&quot;size=&quot;</span> + size.strip + <span class="string">&quot;&amp;&quot;</span> + <span class="string">&quot;time=&quot;</span> + time + <span class="string">&quot;&amp;&quot;</span> + <span class="string">&quot;desc=&quot;</span> + desc + <span class="string">&quot;&amp;&quot;</span> + <span class="string">&quot;pngName=&quot;</span> + pngName + <span class="string">&quot;&amp;&quot;</span> +  <span class="string">&quot;plistUrl=&quot;</span> + plistPath</span><br><span class="line">    myqrAppBuildURL = <span class="string">&quot;http://10.104.33.114/app/index.html?&quot;</span> + <span class="string">&quot;version=&quot;</span> + version + <span class="string">&quot;\\&amp;&quot;</span> + <span class="string">&quot;build=&quot;</span> + new_build + <span class="string">&quot;\\&amp;&quot;</span> + <span class="string">&quot;size=&quot;</span> + size.strip + <span class="string">&quot;\\&amp;&quot;</span> + <span class="string">&quot;time=&quot;</span> + time + <span class="string">&quot;\\&amp;&quot;</span> + <span class="string">&quot;desc=&quot;</span> + desc + <span class="string">&quot;\\&amp;&quot;</span> + <span class="string">&quot;pngName=&quot;</span> + pngName + <span class="string">&quot;\\&amp;&quot;</span> + <span class="string">&quot;plistUrl=&quot;</span> + plistPath</span><br><span class="line">    appQRCodeURL = <span class="string">&quot;http://10.104.33.114/app/icon/&quot;</span> + pngName</span><br><span class="line">    cpath = sh(<span class="string">&quot;pwd&quot;</span>).strip</span><br><span class="line">    <span class="string">`rm -rf <span class="subst">#&#123;cpath&#125;</span>/qrcode.png`</span></span><br><span class="line">    <span class="comment"># myqr生成二维码</span></span><br><span class="line">    <span class="string">`myqr <span class="subst">#&#123;myqrAppBuildURL&#125;</span>`</span></span><br><span class="line">    <span class="string">`mv <span class="subst">#&#123;cpath&#125;</span>/qrcode.png /Users/admin/WebSites/app/icon/<span class="subst">#&#123;pngName&#125;</span>`</span></span><br><span class="line">    UI.message <span class="string">&quot;appBuildURL:<span class="subst">#&#123;appBuildURL&#125;</span>&quot;</span></span><br><span class="line">    UI.message <span class="string">&quot;appQRCodeURL:<span class="subst">#&#123;appQRCodeURL&#125;</span>&quot;</span></span><br><span class="line">    <span class="comment"># 上传蒲公英</span></span><br><span class="line">    uploadPgy(options[<span class="symbol">:desc</span>])</span><br><span class="line">    versionDes = version + <span class="string">&quot; ( build &quot;</span>+ new_build + <span class="string">&quot; )&quot;</span></span><br><span class="line">    description = <span class="string">&quot;打包完成，版本：&quot;</span>+ versionDes + <span class="string">&quot;,包体积：&quot;</span> + size.strip</span><br><span class="line">  <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意 myqr 是生成二维码的python 工具，需要设置环境变量</p>
</blockquote>
<p><img src="/images/iOS-%E8%87%AA%E5%8A%A8%E5%8C%96-%E6%89%93%E5%8C%85/image2020-4-9_17-4-42.png"><br>以上已经实现了打包，接下来上传蒲公英</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 上传蒲公英</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">uploadPgy</span><span class="params">(desc)</span></span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    pgyer(<span class="symbol">api_key:</span> <span class="string">&quot;xxx&quot;</span>,<span class="symbol">user_key:</span> <span class="string">&quot;xxx&quot;</span>,<span class="symbol">update_description:</span><span class="string">&quot;xxx&quot;</span>)</span><br><span class="line">    <span class="keyword">rescue</span></span><br><span class="line">    <span class="keyword">retry</span></span><br><span class="line">  xxx</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>如果实现企业微信通知，其实就是发送一个请求，此时要注意的是fastlane 是ruby 环境，执行shell脚本的 &amp; 或是 双引号需要转义：\  ，并非一个\，例如转义&amp;：\&amp;<br><img src="/images/iOS-自动化-打包/WX20200820-170210@2x.png" width = "300"  alt="" align=center /><br>基本以上已经实现了打包的日常需求了，gym中的export_options是自建内测分发的manifest配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">export_options:&#123;</span><br><span class="line">         manifest: &#123;</span><br><span class="line">             appURL: ipaUrl,</span><br><span class="line">             displayImageURL: disImg,</span><br><span class="line">             fullSizeImageURL: disImg</span><br><span class="line">             &#125;,</span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>以下简单描述一下自建OTA服务</p>
</blockquote>
<ol>
<li>启动Web服务 - Mac自带Apache </li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ httpd -v</span><br><span class="line">Server version: Apache/2.4.41 (Unix)</span><br><span class="line">Server built:   Apr 17 2020 19:06:36</span><br></pre></td></tr></table></figure>
<ul>
<li>启动：sudo apachectl start</li>
<li>停止：sudo apachectl stop</li>
<li>重启：sudo apachectl restart</li>
</ul>
<p>启动sudo apachectl start后浏览器<a target="_blank" rel="noopener" href="http://127.0.0.1,显示it/">http://127.0.0.1，显示It</a> Works即成功</p>
<ol start="2">
<li>SSL签名证书</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ <span class="built_in">cd</span> /private/etc/apache2/</span><br><span class="line">➜  apache2 sudo mkdir ssl</span><br><span class="line">➜  apache2 <span class="built_in">cd</span> ssl</span><br><span class="line">➜  ssl sudo openssl genrsa -out ip211.key 2048</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">...................+++</span><br><span class="line">..............................................................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">➜  ssl sudo openssl req -new -key ip211.key -out ip211.csr</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [AU]:</span><br><span class="line">State or Province Name (full name) [Some-State]:</span><br><span class="line">Locality Name (eg, city) []:</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:</span><br><span class="line">Organizational Unit Name (eg, section) []:</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:127.0.0.1(此处填具体的ip地址)</span><br><span class="line">Email Address []:</span><br><span class="line"></span><br><span class="line">Please enter the following <span class="string">&#x27;extra&#x27;</span> attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:</span><br><span class="line">An optional company name []:</span><br><span class="line">➜  ssl sudo openssl x509 -req -days 365000 -<span class="keyword">in</span> ip211.csr -signkey ip211.key -out ip211.crt</span><br><span class="line">Signature ok</span><br><span class="line">subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd/CN=127.0.0.1</span><br><span class="line">Getting Private key</span><br><span class="line">➜  ssl sudo openssl rsa -<span class="keyword">in</span> ip211.key -out ip211-nopass.key</span><br><span class="line">writing RSA key</span><br><span class="line">➜  ssl ls -l</span><br><span class="line">total 32</span><br><span class="line">-rw-r--r--  1 root  wheel  1679  8 20 17:26 ip211-nopass.key</span><br><span class="line">-rw-r--r--  1 root  wheel  1168  8 20 17:25 ip211.crt</span><br><span class="line">-rw-r--r--  1 root  wheel   985  8 20 17:23 ip211.csr</span><br><span class="line">-rw-r--r--  1 root  wheel  1679  8 20 17:20 ip211.key</span><br></pre></td></tr></table></figure>
<p>只有Common Name填写具体的ip地址</p>
<ol start="3">
<li>修改conf文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  ssl sudo cp /private/etc/apache2/httpd.conf /private/etc/apache2/httpd.conf.bak</span><br><span class="line">Password:</span><br><span class="line">➜  ssl sudo cp /private/etc/apache2/extra/httpd-ssl.conf /private/etc/apache2/extra/httpd-ssl.conf.bak</span><br><span class="line">➜  ssl sudo cp /private/etc/apache2/mime.types /private/etc/apache2/mime.types.bak</span><br><span class="line">➜  ssl sudo vim /private/etc/apache2/httpd.conf</span><br><span class="line">➜  ssl sudo vim /private/etc/apache2/extra/httpd-ssl.conf</span><br><span class="line">➜  ssl sudo vim /private/etc/apache2/mime.types</span><br></pre></td></tr></table></figure>

<p>1）修改/private/etc/apache2/httpd.conf，去掉以下两个模块的注释<br>    LoadModule socache_shmcb_module libexec/apache2/mod_socache_shmcb.so<br>    LoadModule ssl_module libexec/apache2/mod_ssl.so<br>    Include /private/etc/apache2/extra/httpd-ssl.conf</p>
<p>2）修改/private/etc/apache2/extra/httpd-ssl.conf，去掉以下三处的注释<br>    ServerName 127.0.0.1（具体的ip地址）<br>    SSLCertificateFile “/private/etc/apache2/ssl/ip211.crt”<br>    SSLCertificateKeyFile “/private/etc/apache2/ssl/ip211-nopass.key”</p>
<p>3）修改/private/etc/apache2/mime.types，加入以下两条<br>    application/octet-stream ipa<br>    text/xml plist</p>
<ol start="4">
<li>重启服务：sudo apachectl restart，浏览器输入具体ip地址</li>
<li>配置目录</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir ipa</span><br><span class="line">$ sudo mkdir icon</span><br><span class="line">$ sudo mkdir ssl</span><br><span class="line">$ sudo mkdir plist</span><br></pre></td></tr></table></figure>
<p><img src="/images/iOS-%E8%87%AA%E5%8A%A8%E5%8C%96-%E6%89%93%E5%8C%85/WX20200820-181953@2x.png"></p>
<p>拷贝/private/etc/apache2/ssl/ip211.crt 到 这个ssl目录下:<br>sudo cp /private/etc/apache2/ssl/ip211.crt ~/WebSites/app/ssl/ip211.crt </p>
<ol start="6">
<li>制作一个简单的页面<blockquote>
<p>解析链接中的itms-services:// 实现OTA</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span> <span class="attr">lang</span>=<span class="string">&quot;zh-cmn-Hans&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>分发ipa包管理<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;renderer&quot;</span> <span class="attr">content</span>=<span class="string">&quot;webkit&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=Edge,chrome=1&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width,initial-scale=0.5,user-scalable=no&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">  <span class="selector-class">.img</span> &#123;</span></span><br><span class="line">    text-align: center;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">  <span class="selector-class">.btn</span> &#123;</span></span><br><span class="line">    text-align: center;</span><br><span class="line"><span class="css">    <span class="selector-tag">background</span>: <span class="selector-id">#35AF5D</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">color</span>: <span class="selector-id">#000</span>;</span></span><br><span class="line">    padding: 20px;</span><br><span class="line">    margin: 30px;</span><br><span class="line">    font-size: 24px;</span><br><span class="line">    border-radius: 4px;</span><br><span class="line"><span class="css">    <span class="selector-tag">box-shadow</span>: 4<span class="selector-tag">px</span> 2<span class="selector-tag">px</span> 10<span class="selector-tag">px</span> <span class="selector-id">#999</span>;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">  <span class="selector-class">.btn</span><span class="selector-pseudo">:active</span> &#123;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">opacity</span>: <span class="selector-class">.7</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">box-shadow</span>: 4<span class="selector-tag">px</span> 2<span class="selector-tag">px</span> 10<span class="selector-tag">px</span> <span class="selector-id">#555</span>;</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span> <span class="attr">style</span>=<span class="string">&quot;text-align:center;color:#35AF5D&quot;</span>&gt;</span></span><br><span class="line">    工程名</span><br><span class="line">  <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;p1&quot;</span> <span class="attr">style</span>=<span class="string">&quot;text-align:center&quot;</span>&gt;</span></span><br><span class="line">    版本：</span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;p2&quot;</span> <span class="attr">style</span>=<span class="string">&quot;text-align:center&quot;</span>&gt;</span></span><br><span class="line">    大小：</span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;p3&quot;</span> <span class="attr">style</span>=<span class="string">&quot;text-align:center&quot;</span>&gt;</span></span><br><span class="line">    更新时间：</span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;p4&quot;</span> <span class="attr">style</span>=<span class="string">&quot;text-align:center&quot;</span>&gt;</span></span><br><span class="line">    更新描述：</span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;img&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;imgid&quot;</span> <span class="attr">src</span>=<span class="string">&quot;./icon/*.png&quot;</span> <span class="attr">height</span>=<span class="string">&quot;300&quot;</span> <span class="attr">width</span>=<span class="string">&quot;300&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;btn&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;installApp()&quot;</span>&gt;</span>安装app<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">&quot;p1&quot;</span>).innerHTML = <span class="string">&quot;版本：&quot;</span> + getUrlParam(<span class="string">&quot;version&quot;</span>) + <span class="string">&quot; ( build &quot;</span> + getUrlParam(<span class="string">&quot;build&quot;</span>) + <span class="string">&quot; )&quot;</span></span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">&quot;p2&quot;</span>).innerHTML = <span class="string">&quot;大小：&quot;</span> + getUrlParam(<span class="string">&quot;size&quot;</span>) + <span class="string">&quot; KB&quot;</span></span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">&quot;p4&quot;</span>).innerHTML = <span class="string">&quot;更新时间：&quot;</span> + getUrlParam(<span class="string">&quot;time&quot;</span>)</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">&quot;p3&quot;</span>).innerHTML = <span class="string">&quot;更新描述：&quot;</span> + <span class="built_in">decodeURIComponent</span>(getUrlParam(<span class="string">&quot;desc&quot;</span>))</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">&#x27;imgid&#x27;</span>).src = <span class="string">&quot;./icon/&quot;</span> + getUrlParam(<span class="string">&quot;pngName&quot;</span>)</span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">getUrlParam</span>(<span class="params">variable</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> query = <span class="built_in">window</span>.location.search.substring(<span class="number">1</span>);</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> vars = query.split(<span class="string">&quot;&amp;&quot;</span>);</span></span><br><span class="line"><span class="javascript">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; vars.length; i++) &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> pair = vars[i].split(<span class="string">&quot;=&quot;</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (pair[<span class="number">0</span>] == variable) &#123; <span class="keyword">return</span> pair[<span class="number">1</span>]; &#125;</span></span><br><span class="line">      &#125;</span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> (<span class="literal">false</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">installApp</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">var</span> plistUrl = <span class="built_in">decodeURI</span>(getUrlParam(<span class="string">&quot;plistUrl&quot;</span>));</span></span><br><span class="line"><span class="javascript">      <span class="built_in">window</span>.location.href = <span class="string">&quot;itms-services://?action=download-manifest&amp;url=&quot;</span> + plistUrl;</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">style</span>=<span class="string">&quot;display:block;margin: 30px;&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://10.104.33.114/app/ssl/ip211.crt&quot;</span>&gt;</span>下载证书<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&quot;display:block;margin: 30px;&quot;</span>&gt;</span>点击下载证书，下载安装配置文件<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&quot;display:block;margin: 30px;&quot;</span>&gt;</span>在设置-通用-描述文件与设备管理中，选择已下载的配置文件，进行安装<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&quot;display:block;margin: 30px;&quot;</span>&gt;</span>在设置-通用-关于本机-证书信任设置中将完全信任打开<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<img src="/images/iOS-%E8%87%AA%E5%8A%A8%E5%8C%96-%E6%89%93%E5%8C%85/WX20200820-183925@2x.png"></li>
</ol>
<h5 id="二-testflight-自动化公测"><a href="#二-testflight-自动化公测" class="headerlink" title="二. testflight 自动化公测"></a>二. testflight 自动化公测</h5><ol>
<li><p>方案一: 使用fastlane的upload_to_testflight</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">upload_to_testflight(</span><br><span class="line">      <span class="symbol">beta_app_review_info:</span> &#123;</span><br><span class="line">        <span class="symbol">contact_email:</span> <span class="string">&quot;xxxxx@xxx.net&quot;</span>,</span><br><span class="line">        <span class="symbol">contact_first_name:</span> <span class="string">&quot;xx&quot;</span>,</span><br><span class="line">        <span class="symbol">contact_last_name:</span> <span class="string">&quot;xx&quot;</span>,</span><br><span class="line">        <span class="symbol">contact_phone:</span> <span class="string">&quot;+xxxxxx&quot;</span>,</span><br><span class="line">        <span class="symbol">demo_account_name:</span> <span class="string">&quot;xxxxxx&quot;</span>,</span><br><span class="line">        <span class="symbol">demo_account_password:</span> <span class="string">&quot;xxxxx&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">        <span class="symbol">first_name:</span> <span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">        <span class="symbol">last_name:</span> <span class="string">&quot;xxxx&quot;</span>,</span><br><span class="line">        <span class="symbol">email:</span> <span class="string">&quot;xxxxx@xxx.net&quot;</span>,</span><br><span class="line">    <span class="comment">#  true就不自动提审了</span></span><br><span class="line">        <span class="symbol">skip_waiting_for_build_processing:</span> <span class="literal">false</span>,</span><br><span class="line">        <span class="symbol">beta_app_feedback_email:</span><span class="string">&quot;xxxxx@xxx.net&quot;</span>,</span><br><span class="line">        <span class="symbol">beta_app_description:</span>options[<span class="symbol">:desc</span>],</span><br><span class="line">        <span class="symbol">demo_account_required:</span> <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">#构建是否应该分发给外部测试人员？</span></span><br><span class="line">        <span class="symbol">distribute_external:</span> <span class="literal">true</span>,</span><br><span class="line">        <span class="symbol">notify_external_testers:</span> <span class="literal">true</span>,</span><br><span class="line">        <span class="symbol">groups:</span> groups,</span><br><span class="line">        <span class="symbol">changelog:</span>options[<span class="symbol">:desc</span>],</span><br><span class="line">        <span class="symbol">ipa:</span> ipa_path,</span><br><span class="line">        <span class="symbol">localized_app_info:</span> &#123;</span><br><span class="line">          <span class="string">&quot;default&quot;</span>: &#123;</span><br><span class="line">            <span class="symbol">feedback_email:</span> <span class="string">&quot;xxxxx@xxx.net&quot;</span>,</span><br><span class="line">            <span class="symbol">description:</span> <span class="string">&quot;xxxxxxxxxxx&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;zh-Hans&quot;</span>: &#123;</span><br><span class="line">            <span class="symbol">feedback_email:</span> <span class="string">&quot;xxxxx@xxx.net&quot;</span>,</span><br><span class="line">            <span class="symbol">description:</span> <span class="string">&quot;xxxxxxxxx。&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="symbol">localized_build_info:</span> &#123;</span><br><span class="line">          <span class="string">&quot;default&quot;</span>: &#123;</span><br><span class="line">             <span class="symbol">whats_new:</span> options[<span class="symbol">:desc</span>]</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;zh-Hans&quot;</span>: &#123;</span><br><span class="line">             <span class="symbol">whats_new:</span> options[<span class="symbol">:desc</span>]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>但这样有个问题，需要双重验证，通过fastlane spaceauth 生成的session一个月就过期了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 双重验证session一个月过期，执行下面方法输入验证码继续一个月</span></span><br><span class="line"><span class="comment"># fastlane spaceauth -u ios-develop@xxxxx.net</span></span><br><span class="line"><span class="built_in">export</span> FASTLANE_SESSION=<span class="string">&#x27;---\n- !ruby/object:HTTP::Cookie\n ........&#x27;</span></span><br><span class="line"><span class="built_in">export</span> FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD=nqfn-rljf-jipw-kevb</span><br></pre></td></tr></table></figure>
<p>那这个方法其实不太能完美，只能利用 <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/appstoreconnectapi">苹果自动化api</a>来实现</p>
</li>
<li><p>方案二：<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/appstoreconnectapi">苹果自动化api</a></p>
<blockquote>
<p>先ruby封装几个函数</p>
</blockquote>
</li>
</ol>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;base64&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;jwt&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;json&#x27;</span></span><br><span class="line"><span class="comment"># 准备分支信息</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">prepare</span><span class="params">(branch,version,new_build,channel)</span></span></span><br><span class="line">    sh <span class="string">&quot;git checkout <span class="subst">#&#123;branch&#125;</span>&quot;</span></span><br><span class="line">    sh <span class="string">&quot;git pull origin <span class="subst">#&#123;branch&#125;</span>&quot;</span></span><br><span class="line">    increment_build_number(</span><br><span class="line">      <span class="symbol">build_number:</span> new_build,</span><br><span class="line">      <span class="symbol">xcodeproj:</span> <span class="string">&quot;xxxx.xcodeproj&quot;</span></span><br><span class="line">    ) </span><br><span class="line">    increment_version_number(<span class="symbol">version_number:</span> version)  </span><br><span class="line">    tag_string = <span class="string">&quot;<span class="subst">#&#123;channel&#125;</span>_<span class="subst">#&#123;version&#125;</span>.<span class="subst">#&#123;new_build&#125;</span>&quot;</span></span><br><span class="line">    sh <span class="string">&#x27;git add .&#x27;</span></span><br><span class="line">    git_commit(<span class="symbol">path:</span> <span class="string">&#x27;.&#x27;</span>, <span class="symbol">message:</span> tag_string)</span><br><span class="line">    push_to_git_remote(<span class="symbol">tags:</span> <span class="literal">false</span>)</span><br><span class="line">    add_git_tag(<span class="symbol">tag:</span> tag_string)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 上传蒲公英</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">uploadPgy</span><span class="params">(desc)</span></span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      pgyer(<span class="symbol">api_key:</span> <span class="string">&quot;xxxx&quot;</span>,<span class="symbol">user_key:</span> <span class="string">&quot;xxxx&quot;</span>,<span class="symbol">update_description:</span><span class="string">&quot;<span class="subst">#&#123;desc&#125;</span>&quot;</span>)</span><br><span class="line">      <span class="keyword">rescue</span></span><br><span class="line">      <span class="keyword">retry</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 审核状态</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">getBuildState</span><span class="params">(buildid)</span></span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      jwt_token = getToken()</span><br><span class="line">      externalBuildState =  <span class="string">%x(curl  -H &quot;Authorization: Bearer <span class="subst">#&#123;jwt_token&#125;</span>&quot; -H &quot;Content-type: application/json&quot; -s -X GET   https://api.appstoreconnect.apple.com/v1/buildBetaDetails/<span class="subst">#&#123;buildid&#125;</span>  )</span></span><br><span class="line">      state = JSON.parse(externalBuildState)</span><br><span class="line">      buildstate = state[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;attributes&quot;</span>][<span class="string">&quot;externalBuildState&quot;</span>]</span><br><span class="line">      <span class="keyword">rescue</span></span><br><span class="line">      <span class="keyword">retry</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 内审状态</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">getInternalBuildState</span><span class="params">(buildid)</span></span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      jwt_token = getToken()</span><br><span class="line">      externalBuildState =  <span class="string">%x(curl  -H &quot;Authorization: Bearer <span class="subst">#&#123;jwt_token&#125;</span>&quot; -H &quot;Content-type: application/json&quot; -s -X GET   https://api.appstoreconnect.apple.com/v1/buildBetaDetails/<span class="subst">#&#123;buildid&#125;</span>  )</span></span><br><span class="line">      state = JSON.parse(externalBuildState)</span><br><span class="line">      buildstate = state[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;attributes&quot;</span>][<span class="string">&quot;internalBuildState&quot;</span>]</span><br><span class="line">      <span class="keyword">rescue</span></span><br><span class="line">      <span class="keyword">retry</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># 获取build</span></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">getBetaBuild</span><span class="params">(new_build)</span></span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    jwt_token = getToken()</span><br><span class="line">    buildJson =  <span class="string">%x(curl -H &quot;Authorization: Bearer <span class="subst">#&#123;jwt_token&#125;</span>&quot; -H &quot;Content-type: application/json&quot; -X GET https://api.appstoreconnect.apple.com/v1/builds?filter[version]=<span class="subst">#&#123;new_build&#125;</span>)</span></span><br><span class="line">    buildJsonParse = JSON.parse(buildJson)</span><br><span class="line">    buildid = buildJsonParse[<span class="string">&quot;data&quot;</span>][<span class="number">0</span>][<span class="string">&quot;id&quot;</span>]</span><br><span class="line">    <span class="keyword">rescue</span></span><br><span class="line">      sleep <span class="number">5</span> * <span class="number">60</span></span><br><span class="line">    <span class="keyword">retry</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">     <span class="comment"># 测试人员添加测试组中</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">getBetaTesters</span><span class="params">(groupid)</span></span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      jwt_token = getToken()</span><br><span class="line">      betaTesters = <span class="string">%x(curl -H &quot;Authorization: Bearer <span class="subst">#&#123;jwt_token&#125;</span>&quot; -H &quot;Content-type: application/json&quot; -X POST -d &#x27;&#123;&quot;data&quot;: &#123;&quot;type&quot;: &quot;betaTesters&quot;,&quot;attributes&quot;: &#123;&quot;firstName&quot;:&quot;xx&quot;,&quot;lastName&quot;:&quot;xx&quot;,&quot;email&quot;:&quot;xx@xxx.net&quot;&#125;,&quot;relationships&quot;: &#123;&quot;betaGroups&quot;:&#123;&quot;data&quot;:[&#123;&quot;type&quot;:&quot;betaGroups&quot;,&quot;id&quot;:&quot;<span class="subst">#&#123;groupid&#125;</span>&quot;&#125;]&#125;&#125;&#125;&#125;&#x27; https://api.appstoreconnect.apple.com/v1/betaTesters)</span></span><br><span class="line">      puts <span class="string">&quot;将测试人员添加到组中: <span class="subst">#&#123;betaTesters&#125;</span>&quot;</span></span><br><span class="line">      betaTestersData = JSON.parse(betaTesters)</span><br><span class="line">      id = betaTestersData[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;id&quot;</span>]</span><br><span class="line">      <span class="keyword">rescue</span></span><br><span class="line">        sleep <span class="number">5</span> * <span class="number">60</span></span><br><span class="line">      <span class="keyword">retry</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 创建组</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">createGroup</span><span class="params">(groups)</span></span></span><br><span class="line">    jwt_token = getToken()</span><br><span class="line">    puts <span class="string">&quot;令牌:<span class="subst">#&#123;jwt_token&#125;</span>&quot;</span></span><br><span class="line">    <span class="comment"># 创建组</span></span><br><span class="line">    groupJson = <span class="string">%x(curl -H &quot;Authorization: Bearer <span class="subst">#&#123;jwt_token&#125;</span>&quot; -H &quot;Content-type: application/json&quot; -X POST -d &#x27;&#123;&quot;data&quot;: &#123;&quot;type&quot;: &quot;betaGroups&quot;,&quot;attributes&quot;: &#123;&quot;name&quot;:&quot;<span class="subst">#&#123;groups&#125;</span>&quot;&#125;,&quot;relationships&quot;: &#123;&quot;app&quot;: &#123;&quot;data&quot;:&#123;&quot;type&quot;:&quot;apps&quot;,&quot;id&quot;:&quot;xxxx&quot;&#125;&#125;&#125;&#125;&#125;&#x27; https://api.appstoreconnect.apple.com/v1/betaGroups)</span></span><br><span class="line">    groupJsonParse = JSON.parse(groupJson)</span><br><span class="line">    groupid = groupJsonParse[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;id&quot;</span>]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># build添加测试组中</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">addBetaGroups</span><span class="params">(groupid,buildid)</span></span></span><br><span class="line">      jwt_token = getToken()</span><br><span class="line">      <span class="comment"># 将版本添加到组中</span></span><br><span class="line">      insertBetaGroups = <span class="string">%x(curl -H &quot;Authorization: Bearer <span class="subst">#&#123;jwt_token&#125;</span>&quot; -H &quot;Content-type: application/json&quot; -X POST -d &#x27;&#123;&quot;data&quot;: [&#123;&quot;type&quot;: &quot;builds&quot;,&quot;id&quot;:&quot;<span class="subst">#&#123;buildid&#125;</span>&quot;&#125;]&#125;&#x27; https://api.appstoreconnect.apple.com/v1/betaGroups/<span class="subst">#&#123;groupid&#125;</span>/relationships/builds)</span></span><br><span class="line">      puts <span class="string">&quot;将版本添加到组中: <span class="subst">#&#123;insertBetaGroups&#125;</span>&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 获取本地化id</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">getBetaBuildLocalizationsid</span><span class="params">(buildid,desc)</span></span></span><br><span class="line">      jwt_token = getToken()</span><br><span class="line">      createBetaBuildLocalizationsJson =  <span class="string">%x(curl -H &quot;Authorization: Bearer <span class="subst">#&#123;jwt_token&#125;</span>&quot; -H &quot;Content-type: application/json&quot; -X POST -d &#x27;&#123; &quot;data&quot;: &#123;&quot;type&quot;: &quot;betaBuildLocalizations&quot;,&quot;attributes&quot;: &#123;&quot;whatsNew&quot;: &quot;<span class="subst">#&#123;desc&#125;</span>&quot;,&quot;locale&quot;:&quot;zh-Hans&quot;&#125;,&quot;relationships&quot;: &#123;&quot;build&quot;:&#123;&quot;data&quot;:&#123;&quot;id&quot;:&quot;<span class="subst">#&#123;buildid&#125;</span>&quot;,&quot;type&quot;:&quot;builds&quot;&#125;&#125;&#125;&#125;&#125;&#x27; https://api.appstoreconnect.apple.com/v1/betaBuildLocalizations)</span></span><br><span class="line">      puts <span class="string">&quot;createBetaBuildLocalizationsJson: <span class="subst">#&#123;createBetaBuildLocalizationsJson&#125;</span>&quot;</span></span><br><span class="line">      betaBuildLocalizationsJson =  <span class="string">%x(curl -H &quot;Authorization: Bearer <span class="subst">#&#123;jwt_token&#125;</span>&quot; -H &quot;Content-type: application/json&quot; -X GET https://api.appstoreconnect.apple.com/v1/betaBuildLocalizations?filter[build]=<span class="subst">#&#123;buildid&#125;</span>&amp;filter[locale]=zh-Hans)</span></span><br><span class="line">      betaBuildLocalizationsParse = JSON.parse(betaBuildLocalizationsJson)</span><br><span class="line">      puts <span class="string">&quot;betaBuildLocalizationsJson: <span class="subst">#&#123;betaBuildLocalizationsJson&#125;</span>&quot;</span></span><br><span class="line">      betaBuildLocalizationsid = betaBuildLocalizationsParse[<span class="string">&quot;data&quot;</span>][<span class="number">0</span>][<span class="string">&quot;id&quot;</span>]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 本地化信息</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">patchBetaBuildLocalizations</span><span class="params">(betaBuildLocalizationsid,desc)</span></span></span><br><span class="line">      jwt_token = getToken()</span><br><span class="line">      patchBetaBuildLocalizations = <span class="string">%x(curl -H &quot;Authorization: Bearer <span class="subst">#&#123;jwt_token&#125;</span>&quot; -H &quot;Content-type: application/json&quot; -X PATCH -d &#x27;&#123; &quot;data&quot;: &#123;&quot;type&quot;: &quot;betaBuildLocalizations&quot;,&quot;attributes&quot;: &#123;&quot;whatsNew&quot;: &quot;<span class="subst">#&#123;desc&#125;</span>&quot;&#125;,&quot;id&quot;: &quot;<span class="subst">#&#123;betaBuildLocalizationsid&#125;</span>&quot;&#125;&#125;&#x27; https://api.appstoreconnect.apple.com/v1/betaBuildLocalizations/<span class="subst">#&#123;betaBuildLocalizationsid&#125;</span>)</span></span><br><span class="line">      puts <span class="string">&quot;本地化信息: <span class="subst">#&#123;patchBetaBuildLocalizations&#125;</span>&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="comment"># 启用公测链接</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">getPublic_link</span><span class="params">(groupid,groups)</span></span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      jwt_token = getToken()</span><br><span class="line">      public_link_json = <span class="string">%x(curl -H &quot;Authorization: Bearer <span class="subst">#&#123;jwt_token&#125;</span>&quot; -H &quot;Content-type: application/json&quot; -X PATCH -d &#x27;&#123;&quot;data&quot;: &#123;&quot;type&quot;: &quot;betaGroups&quot;,&quot;id&quot;: &quot;<span class="subst">#&#123;groupid&#125;</span>&quot;,&quot;attributes&quot;: &#123;&quot;name&quot;: &quot;<span class="subst">#&#123;groups&#125;</span>&quot;,&quot;publicLinkEnabled&quot;: true,&quot;publicLinkLimitEnabled&quot;: false,&quot;publicLinkLimit&quot;: null,&quot;feedbackEnabled&quot;: true&#125;&#125;&#125;&#x27; https://api.appstoreconnect.apple.com/v1/betaGroups/<span class="subst">#&#123;groupid&#125;</span>)</span></span><br><span class="line">      puts <span class="string">&quot;链接请求: <span class="subst">#&#123;public_link_json&#125;</span>&quot;</span></span><br><span class="line">      public_link_json_parse = JSON.parse(public_link_json)</span><br><span class="line">      public_link = public_link_json_parse[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;attributes&quot;</span>][<span class="string">&quot;publicLink&quot;</span>]</span><br><span class="line">      <span class="keyword">rescue</span></span><br><span class="line">        sleep <span class="number">5</span> * <span class="number">60</span></span><br><span class="line">      <span class="keyword">retry</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment"># 获取苹果凭据token</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">getToken</span> </span></span><br><span class="line">    private_key = OpenSSL::PKey.read(File.read(<span class="string">&quot;/Users/admin/AuthKey_xxxxx.p8&quot;</span>))</span><br><span class="line">    token = JWT.encode(</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="symbol">iss:</span> <span class="string">&quot;xxxxx-xxxx-xxxxxx-xxxx-xxxxxx&quot;</span>,</span><br><span class="line">      <span class="symbol">exp:</span> Time.now.to_i + <span class="number">20</span> * <span class="number">60</span>,</span><br><span class="line">      <span class="symbol">aud:</span> <span class="string">&quot;appstoreconnect-v1&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    private_key,</span><br><span class="line">    <span class="string">&quot;ES256&quot;</span>,</span><br><span class="line">    header_fields=&#123;<span class="symbol">kid:</span> <span class="string">&quot;xxxxx&quot;</span> &#125;</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>此处根据 <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/appstoreconnectapi">苹果自动化api</a>文档先本地通过postman去调试验证，如下图，header中的Authorization为key，value为 “Bearer 苹果凭据token”</p>
<p><img src="/images/iOS-%E8%87%AA%E5%8A%A8%E5%8C%96-%E6%89%93%E5%8C%85/WX20200821-111336@2x.png"></p>
<p>具体实现</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">desc <span class="string">&quot;发布testflight版本&quot;</span></span><br><span class="line">  lane <span class="symbol">:testflight</span> <span class="keyword">do</span>  <span class="params">|options|</span></span><br><span class="line">    <span class="comment">#新建build号</span></span><br><span class="line">    new_build = options[<span class="symbol">:new_build</span>]</span><br><span class="line">    desc = options[<span class="symbol">:desc</span>]</span><br><span class="line">    puts <span class="string">&quot;desc:<span class="subst">#&#123;desc&#125;</span>&quot;</span></span><br><span class="line">    time = Time.new.strftime(<span class="string">&quot;%Y-%m-%d-%H:%M:%S&quot;</span>)</span><br><span class="line">    increment_build_number(</span><br><span class="line">      <span class="symbol">build_number:</span> new_build,</span><br><span class="line">      <span class="symbol">xcodeproj:</span> <span class="string">&quot;xxxx.xcodeproj&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    new_version = options[<span class="symbol">:new_version</span>]</span><br><span class="line">    <span class="keyword">if</span> !new_version.empty?</span><br><span class="line">     increment_version_number(<span class="symbol">version_number:</span> new_version)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    sh(<span class="string">&quot;pod repo update&quot;</span>)</span><br><span class="line">    <span class="comment"># 拉取代码</span></span><br><span class="line">    cocoapods</span><br><span class="line">    <span class="comment"># 获取版本号</span></span><br><span class="line">    version = get_version_number(</span><br><span class="line">      <span class="symbol">xcodeproj:</span> <span class="string">&quot;xxxx.xcodeproj&quot;</span>,</span><br><span class="line">      <span class="symbol">target:</span> <span class="string">&quot;xxxx&quot;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 打包环境</span></span><br><span class="line">    configuration = <span class="string">&quot;Release&quot;</span></span><br><span class="line">    ipaName=<span class="string">&quot;xxxx&quot;</span></span><br><span class="line">    ipaPath=configuration + <span class="string">&quot;/&quot;</span> + version + <span class="string">&quot;.&quot;</span> + new_build + <span class="string">&quot;/&quot;</span></span><br><span class="line">    <span class="comment"># 导出ipa包地址</span></span><br><span class="line">    output_directory = <span class="string">&quot;/Users/admin/WebSites/app/ipa/&quot;</span> + ipaPath</span><br><span class="line">    <span class="comment">#manifest.plilst需要的参数</span></span><br><span class="line">    ipaUrl=<span class="string">&#x27;https://10.104.33.114/app/ipa/&#x27;</span> + ipaPath + ipaName + <span class="string">&#x27;.ipa&#x27;</span></span><br><span class="line">    plistPath = <span class="string">&#x27;https://10.104.33.114/app/ipa/&#x27;</span> + ipaPath + <span class="string">&#x27;manifest.plist&#x27;</span></span><br><span class="line">    pngName = version + <span class="string">&quot;.&quot;</span> + new_build + <span class="string">&#x27;.png&#x27;</span></span><br><span class="line">    disImg =<span class="string">&#x27;https://10.104.33.114/app/icon/&#x27;</span> + pngName</span><br><span class="line">    gym(</span><br><span class="line">      <span class="symbol">scheme:</span> <span class="string">&quot;xxxx&quot;</span>,</span><br><span class="line">      <span class="symbol">workspace:</span> <span class="string">&quot;xxx.xcworkspace&quot;</span>,</span><br><span class="line">      <span class="symbol">export_method:</span><span class="string">&quot;app-store&quot;</span>,</span><br><span class="line">      <span class="symbol">export_xcargs:</span> <span class="string">&quot;-allowProvisioningUpdates&quot;</span>,</span><br><span class="line">      <span class="symbol">output_directory:</span> output_directory,<span class="comment">#文件路径</span></span><br><span class="line">      <span class="symbol">clean:</span> <span class="literal">true</span>,</span><br><span class="line">      <span class="symbol">configuration:</span> configuration,</span><br><span class="line">      <span class="symbol">export_options:</span>&#123;</span><br><span class="line">         <span class="symbol">manifest:</span> &#123;</span><br><span class="line">             <span class="symbol">appURL:</span> ipaUrl,</span><br><span class="line">             <span class="symbol">displayImageURL:</span> disImg,</span><br><span class="line">             <span class="symbol">fullSizeImageURL:</span> disImg</span><br><span class="line">             &#125;,</span><br><span class="line">         &#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    ipa_path = output_directory + ipaName + <span class="string">&#x27;.ipa&#x27;</span></span><br><span class="line">    groups = version + <span class="string">&quot;.&quot;</span> + new_build</span><br><span class="line">    apiIssuer = <span class="string">&quot;xxxxxxxxxxxxxxx&quot;</span>;</span><br><span class="line">    apiKey = <span class="string">&quot;xxxxxx&quot;</span>;</span><br><span class="line">    <span class="string">`xcrun altool --validate-app -f <span class="subst">#&#123;ipa_path&#125;</span>  -t ios --apiKey <span class="subst">#&#123;apiKey&#125;</span> --apiIssuer <span class="subst">#&#123;apiIssuer&#125;</span>`</span></span><br><span class="line">    validate_status = <span class="string">`echo $?`</span></span><br><span class="line">    puts <span class="string">&quot;======================== validate ========================&quot;</span></span><br><span class="line">    puts <span class="string">&quot;<span class="subst">#&#123;validate_status&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">if</span> Integer(validate_status) != <span class="number">0</span></span><br><span class="line">      puts <span class="string">&quot;======================== 验证出错 ========================&quot;</span></span><br><span class="line">      exit</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    puts <span class="string">&quot;======================== 验证成功 ========================&quot;</span></span><br><span class="line">    <span class="string">`xcrun altool --upload-app -f <span class="subst">#&#123;ipa_path&#125;</span> -t ios --apiKey <span class="subst">#&#123;apiKey&#125;</span> --apiIssuer <span class="subst">#&#123;apiIssuer&#125;</span>`</span></span><br><span class="line">    upload_status = <span class="string">`echo $?`</span></span><br><span class="line">    puts <span class="string">&quot;======================== upload ========================&quot;</span></span><br><span class="line">    puts <span class="string">&quot;<span class="subst">#&#123;upload_status&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">if</span> Integer(upload_status) != <span class="number">0</span></span><br><span class="line">      puts <span class="string">&quot;======================== 上传出错 ========================&quot;</span></span><br><span class="line">      exit</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    puts <span class="string">&quot;======================== 上传成功 ========================&quot;</span></span><br><span class="line">    size =<span class="string">`echo $(wc -c &lt; <span class="subst">#&#123;output_directory&#125;</span><span class="subst">#&#123;ipaName&#125;</span>.ipa)`</span></span><br><span class="line">    desc = URI::encode(options[<span class="symbol">:desc</span>])</span><br><span class="line">    appBuildURL = <span class="string">&quot;http://10.104.33.114/app/index.html?&quot;</span> + <span class="string">&quot;version=&quot;</span> + version + <span class="string">&quot;&amp;&quot;</span> + <span class="string">&quot;build=&quot;</span> + new_build + <span class="string">&quot;&amp;&quot;</span> + <span class="string">&quot;size=&quot;</span> + size.strip + <span class="string">&quot;&amp;&quot;</span> + <span class="string">&quot;time=&quot;</span> + time + <span class="string">&quot;&amp;&quot;</span> + <span class="string">&quot;desc=&quot;</span> + desc + <span class="string">&quot;&amp;&quot;</span> + <span class="string">&quot;pngName=&quot;</span> + pngName + <span class="string">&quot;&amp;&quot;</span> +  <span class="string">&quot;plistUrl=&quot;</span> + plistPath</span><br><span class="line">    myqrAppBuildURL = <span class="string">&quot;http://10.104.33.114/app/index.html?&quot;</span> + <span class="string">&quot;version=&quot;</span> + version + <span class="string">&quot;\\&amp;&quot;</span> + <span class="string">&quot;build=&quot;</span> + new_build + <span class="string">&quot;\\&amp;&quot;</span> + <span class="string">&quot;size=&quot;</span> + size.strip + <span class="string">&quot;\\&amp;&quot;</span> + <span class="string">&quot;time=&quot;</span> + time + <span class="string">&quot;\\&amp;&quot;</span> + <span class="string">&quot;desc=&quot;</span> + desc + <span class="string">&quot;\\&amp;&quot;</span> + <span class="string">&quot;pngName=&quot;</span> + pngName + <span class="string">&quot;\\&amp;&quot;</span> + <span class="string">&quot;plistUrl=&quot;</span> + plistPath</span><br><span class="line">    appQRCodeURL = <span class="string">&quot;http://10.104.33.114/app/icon/&quot;</span> + pngName</span><br><span class="line">    cpath = sh(<span class="string">&quot;pwd&quot;</span>).strip</span><br><span class="line">    <span class="string">`rm -rf <span class="subst">#&#123;cpath&#125;</span>/qrcode.png`</span></span><br><span class="line">    <span class="string">`myqr <span class="subst">#&#123;myqrAppBuildURL&#125;</span>`</span></span><br><span class="line">    <span class="string">`mv <span class="subst">#&#123;cpath&#125;</span>/qrcode.png /Users/admin/WebSites/app/icon/<span class="subst">#&#123;pngName&#125;</span>`</span></span><br><span class="line">    UI.message <span class="string">&quot;appBuildURL:<span class="subst">#&#123;appBuildURL&#125;</span>&quot;</span></span><br><span class="line">    UI.message <span class="string">&quot;appQRCodeURL:<span class="subst">#&#123;appQRCodeURL&#125;</span>&quot;</span></span><br><span class="line">    description = <span class="string">&quot;公测包：&quot;</span>+ groups</span><br><span class="line">    UI.message <span class="string">&quot;description:<span class="subst">#&#123;description&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取build</span></span><br><span class="line">    buildJson = getBetaBuild(new_build)</span><br><span class="line">    puts <span class="string">&quot;buildid:<span class="subst">#&#123;buildid&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 轮询</span></span><br><span class="line">    internalBuildStat =  getInternalBuildState(buildid)</span><br><span class="line">    puts <span class="string">&quot;提交内审状态:<span class="subst">#&#123;internalBuildStat&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> !(internalBuildStat.casecmp?(<span class="string">&quot;IN_BETA_TESTING&quot;</span>))  <span class="keyword">do</span></span><br><span class="line">      sleep <span class="number">5</span> * <span class="number">60</span></span><br><span class="line">      internalBuildStat =  getInternalBuildState(buildid)</span><br><span class="line">      puts <span class="string">&quot;提交内审状态:<span class="subst">#&#123;internalBuildStat&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 发出企业微信通知：可以提交审核</span></span><br><span class="line">    sleep <span class="number">5</span> * <span class="number">60</span></span><br><span class="line">    jwt_token = getToken()</span><br><span class="line">    <span class="comment"># 提交审核</span></span><br><span class="line">    betaAppReviewSubmissions = <span class="string">%x(curl -H &quot;Authorization: Bearer <span class="subst">#&#123;jwt_token&#125;</span>&quot; -H &quot;Content-type: application/json&quot; -X POST -d &#x27;&#123;&quot;data&quot;: &#123;&quot;type&quot;: &quot;betaAppReviewSubmissions&quot;,&quot;relationships&quot;: &#123;&quot;build&quot;: &#123;&quot;data&quot;:&#123;&quot;type&quot;:&quot;builds&quot;,&quot;id&quot;:&quot;<span class="subst">#&#123;buildid&#125;</span>&quot;&#125;&#125;&#125;&#125;&#125;&#x27; https://api.appstoreconnect.apple.com/v1/betaAppReviewSubmissions)</span></span><br><span class="line">    puts <span class="string">&quot;审核请求结果:<span class="subst">#&#123;betaAppReviewSubmissions&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取审核状态</span></span><br><span class="line">    buildstate =  getBuildState(buildid)</span><br><span class="line">    puts <span class="string">&quot;审核状态:<span class="subst">#&#123;buildstate&#125;</span>&quot;</span></span><br><span class="line">    laststate = buildstate</span><br><span class="line">    <span class="keyword">if</span> buildstate.casecmp?(<span class="string">&quot;WAITING_FOR_BETA_REVIEW&quot;</span>)</span><br><span class="line">      <span class="comment"># 发出企业微信通知：等待审核状态</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> buildstate.casecmp?(<span class="string">&quot;IN_REVIEW&quot;</span>)</span><br><span class="line">      <span class="comment"># 发出企业微信通知</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 轮询查看审核状态（每隔10分钟）</span></span><br><span class="line">    <span class="keyword">while</span> !(buildstate.casecmp?(<span class="string">&quot;IN_BETA_TESTING&quot;</span>) <span class="params">||</span> buildstate.casecmp?(<span class="string">&quot;APPROVED&quot;</span>) <span class="params">||</span> buildstate.casecmp?(<span class="string">&quot;REJECTED&quot;</span>) <span class="params">||</span> buildstate.casecmp?(<span class="string">&quot;BETA_APPROVED&quot;</span>) <span class="params">||</span> buildstate.casecmp?(<span class="string">&quot;BETA_REJECTED&quot;</span>))  <span class="keyword">do</span></span><br><span class="line">      sleep <span class="number">10</span> * <span class="number">60</span></span><br><span class="line">      buildstate =  getBuildState(buildid)</span><br><span class="line">      <span class="keyword">if</span> !laststate.casecmp?(buildstate)</span><br><span class="line">        <span class="keyword">if</span> (buildstate.casecmp?(<span class="string">&quot;IN_REVIEW&quot;</span>) <span class="params">||</span> buildstate.casecmp?(<span class="string">&quot;IN_BETA_REVIEW&quot;</span>))</span><br><span class="line">          <span class="comment"># 发出企业微信通知</span></span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            <span class="comment"># 发出企业微信通知</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      laststate =  buildstate;</span><br><span class="line">      puts <span class="string">&quot;审核状态:<span class="subst">#&#123;buildstate&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buildstate.casecmp?(<span class="string">&quot;REJECTED&quot;</span>) <span class="params">||</span> buildstate.casecmp?(<span class="string">&quot;BETA_REJECTED&quot;</span>))</span><br><span class="line">      <span class="comment"># 发出企业微信通知：等待审核状态</span></span><br><span class="line">        puts <span class="string">&quot;<span class="subst">#&#123;groups&#125;</span> 公测审核被拒，请前往App Store查看原因&quot;</span></span><br><span class="line">        exit</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buildstate.casecmp?(<span class="string">&quot;IN_BETA_TESTING&quot;</span>) <span class="params">||</span> buildstate.casecmp?(<span class="string">&quot;APPROVED&quot;</span>) <span class="params">||</span> buildstate.casecmp?(<span class="string">&quot;BETA_APPROVED&quot;</span>))</span><br><span class="line"></span><br><span class="line">      jwt_token = getToken()</span><br><span class="line">      puts <span class="string">&quot;令牌:<span class="subst">#&#123;jwt_token&#125;</span>&quot;</span></span><br><span class="line">      <span class="comment"># 创建组</span></span><br><span class="line">      groupid = createGroup(groups)</span><br><span class="line">      puts <span class="string">&quot;获取到组id:<span class="subst">#&#123;groupid&#125;</span>&quot;</span></span><br><span class="line">      sleep <span class="number">5</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 将测试人员添加到组中</span></span><br><span class="line">      getBetaTesters(groupid)</span><br><span class="line">      sleep <span class="number">5</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 将build添加到组中</span></span><br><span class="line">      addBetaGroups(groupid,buildid)</span><br><span class="line">      sleep <span class="number">5</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">#获取本地化id</span></span><br><span class="line">      betaBuildLocalizationsid = getBetaBuildLocalizationsid(buildid,options[<span class="symbol">:desc</span>])</span><br><span class="line">      puts <span class="string">&quot;betaBuildLocalizationsid:<span class="subst">#&#123;betaBuildLocalizationsid&#125;</span>&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">#修改本地化测试信息</span></span><br><span class="line">      patchBetaBuildLocalizations(betaBuildLocalizationsid,options[<span class="symbol">:desc</span>])</span><br><span class="line"></span><br><span class="line">      <span class="comment"># 启用公测链接</span></span><br><span class="line">      public_link = getPublic_link(groupid,groups)</span><br><span class="line">      puts <span class="string">&quot;公测链接: <span class="subst">#&#123;public_link&#125;</span>&quot;</span></span><br><span class="line">      new_branch = options[<span class="symbol">:new_branch</span>]</span><br><span class="line">      prepare(new_branch,version,new_build,<span class="string">&#x27;testflight&#x27;</span>)</span><br><span class="line">      push_git_tags</span><br><span class="line">      <span class="comment"># 上传bugly</span></span><br><span class="line">      dsymFilePath = output_directory + <span class="string">&#x27;xxxx.app.dSYM.zip&#x27;</span></span><br><span class="line">      upload_dsym_to_bugly(</span><br><span class="line">        <span class="symbol">file_path:</span> <span class="string">&quot;<span class="subst">#&#123;dsymFilePath&#125;</span>&quot;</span>,</span><br><span class="line">        <span class="symbol">file_name:</span> <span class="string">&quot;%e8%b6%axxxxxxx%.app.dSYM.zip&quot;</span>,</span><br><span class="line">        <span class="symbol">app_key:</span> <span class="string">&quot;xxxxxxx&quot;</span>,</span><br><span class="line">        <span class="symbol">app_id:</span><span class="string">&quot;xxxxxxx&quot;</span>,</span><br><span class="line">        <span class="symbol">api_version:</span> <span class="number">1</span>,</span><br><span class="line">        <span class="symbol">symbol_type:</span> <span class="number">2</span>, <span class="comment"># iOS =&gt; 2, Android =&gt; 1</span></span><br><span class="line">        <span class="symbol">bundle_id:</span> <span class="string">&#x27;com.xxxx.xxxx&#x27;</span>,</span><br><span class="line">        <span class="symbol">product_version:</span> <span class="string">&quot;<span class="subst">#&#123;groups&#125;</span>&quot;</span></span><br><span class="line">      ) </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="三-总结"><a href="#三-总结" class="headerlink" title="三. 总结"></a>三. 总结</h5><ol>
<li>公测自动化实现后，App Store打包通过打包验证和上传也很容易实现</li>
<li>Jenkins + fastlane 较为方便的实现可持续集成自动化的流程</li>
<li>python、ruby、shell等语言实现脚本思想一样，哪个方便用哪个</li>
<li>能工具化提高效率的尽量工具化自动化，为公司节省人力，提高工作效率</li>
<li>消息通知最终流程过程或结果可以采用邮件、webhook机器人消息等</li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/" rel="tag"># 自动化</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
            </div>
            <div class="post-nav-item">
                <a href="/2020/08/22/%E5%85%B3%E4%BA%8EWKWebView-%E7%A7%92%E5%BC%80%E6%96%B9%E6%A1%88/" rel="next" title="关于WKWebView 秒开方案">
                  关于WKWebView 秒开方案 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
  
  
  



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">钟环</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">51k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">47 分钟</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@next-theme/pjax@0.4.0/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>
  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '.page-configurations',
    '.main-inner',
    '.post-toc-wrap',
    '.languages',
    '.pjax'
  ],
  analytics: false,
  cacheBust: false,
  scrollRestoration: false,
  scrollTo: !CONFIG.bookmark.enable
});

document.addEventListener('pjax:success', () => {
  pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  const hasTOC = document.querySelector('.post-toc');
  document.querySelector('.sidebar-inner').classList.toggle('sidebar-nav-active', hasTOC);
  document.querySelector(hasTOC ? '.sidebar-nav-toc' : '.sidebar-nav-overview').click();
  NexT.utils.updateSidebarPosition();
});
</script>


  




  <script src="/js/local-search.js"></script>












  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








    <div class="pjax">
  

  

    </div>
</body>
</html>
